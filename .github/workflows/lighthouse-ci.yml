name: Lighthouse CI

on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      url:
        description: 'URL to test (defaults to production)'
        required: false
        type: string
        default: 'https://smart-agent-platform.vercel.app'

jobs:
  lighthouse:
    name: Lighthouse Performance Audit
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Lighthouse CI
        run: npm install -g @lhci/cli@latest

      - name: Run Lighthouse CI
        id: lighthouse
        continue-on-error: true
        env:
          LHCI_GITHUB_APP_TOKEN: ${{ secrets.LHCI_GITHUB_APP_TOKEN }}
          TEST_URL: ${{ github.event.inputs.url || 'https://smart-agent-platform.vercel.app' }}
        run: |
          # Create temporary config if URL is provided
          if [ -n "${{ github.event.inputs.url }}" ]; then
            cat > .lighthouserc.tmp.js <<EOF
          module.exports = {
            ci: {
              collect: {
                url: ['${{ github.event.inputs.url }}'],
                numberOfRuns: 3,
              },
              assert: {
                assertions: {
                  'categories:performance': ['error', {minScore: 0.7}],
                  'categories:accessibility': ['error', {minScore: 0.9}],
                  'categories:best-practices': ['error', {minScore: 0.85}],
                  'categories:seo': ['error', {minScore: 0.8}],
                  'first-contentful-paint': ['error', {maxNumericValue: 2000}],
                  'largest-contentful-paint': ['error', {maxNumericValue: 2500}],
                  'total-blocking-time': ['error', {maxNumericValue: 300}],
                  'cumulative-layout-shift': ['error', {maxNumericValue: 0.1}],
                }
              },
              upload: {
                target: 'temporary-public-storage',
              },
            },
          };
          EOF
            lhci autorun --config=.lighthouserc.tmp.js
          else
            lhci autorun
          fi

      - name: Upload Lighthouse results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lighthouse-results
          path: .lighthouseci/
          retention-days: 30

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const path = require('path');
            
            // Try to read Lighthouse results
            let comment = '## üîç Lighthouse CI Results\n\n';
            
            try {
              const resultsPath = '.lighthouseci';
              if (fs.existsSync(resultsPath)) {
                const files = fs.readdirSync(resultsPath);
                const jsonFiles = files.filter(f => f.endsWith('.json'));
                
                if (jsonFiles.length > 0) {
                  comment += '‚úÖ Lighthouse audit completed\n\n';
                  comment += 'üìä **Performance Metrics:**\n';
                  comment += '- Check the uploaded artifacts for detailed reports\n';
                  comment += '- View full report: [Lighthouse CI Dashboard](https://googlechrome.github.io/lighthouse-ci/viewer/)\n\n';
                } else {
                  comment += '‚ö†Ô∏è Lighthouse audit completed but no results found\n';
                }
              } else {
                comment += '‚ö†Ô∏è Lighthouse results directory not found\n';
              }
            } catch (error) {
              comment += `‚ö†Ô∏è Error reading results: ${error.message}\n`;
            }
            
            comment += '\n---\n';
            comment += '*This comment is automatically generated by Lighthouse CI*';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

      - name: Fail if Lighthouse thresholds not met
        if: steps.lighthouse.outcome == 'failure'
        run: |
          echo "‚ùå Lighthouse CI failed - performance thresholds not met"
          echo "Check the uploaded artifacts for detailed reports"
          exit 1
